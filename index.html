<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Power of Knoydart</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="css/normalize.min.css">
        <link rel="stylesheet" href="css/main.css">
        <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
        <link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">        
        <script src="js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
        <script src="chartjs/Chart.js"></script>
        <script src="chartjs/dirty_linebar.js"></script>
        <script src="js/spin.js"></script>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <div class="header-container">
            <header class="wrapper clearfix">
                <h1 class="title">The Power of Knoydart</h1>
                <nav>
                    <ul>
                        <li class="chartToggle" id="demand"><a href="#">Power Demand</a></li>
                        <li class="chartToggle" id="rainfall"><a href="#">Rainfall &amp; Dam Level</a></li>
                        <li class="chartToggle" id="production"><a href="#">Energy Production</a></li>
                    </ul>
                </nav>
            </header>
        </div>

        <div class="main-container">
            <div class="main wrapper clearfix">

                <article>
                    <div id="graphContainer" class="graphContainer">
                        <canvas id="graphCanvas"></canvas>
                    </div>

                    <script>
                        
                        $(document).ready(function() {
                            // Detect clicks on time intervals
                            $('.btn').click(function(event) {
                                if(isLoading){
                                    return;
                                }

                                var label = $(this)[0].innerText;
                                var intervalFullName = "";

                                if (label.indexOf("Hour") >= 0) {
                                    intervalFullName = "lastHour";
                                } else if (label.indexOf("Day") >= 0) {
                                    intervalFullName = "lastDay";
                                } else if (label.indexOf("Week") >= 0) {
                                    intervalFullName = "lastWeek";
                                } else if (label.indexOf("Month") >= 0) {
                                    intervalFullName = "lastMonth";
                                };

                                if(intervalFullName === currentInterval){
                                    return;
                                }

                                currentInterval = intervalFullName;

                                if(datasets[currentInterval].data){
                                    return;
                                }

                                console.log('loading in new interval set');
                                resetCanvas();
                                downloadDataset(intervalFullName);
                            });

                            // Detect clicks across the top nav to change datasets
                            $('.chartToggle').click(function(event) {

                                if(isLoading){
                                    return;
                                }

                                if(currentChart !== $(this)[0].id){
                                    currentChart = $(this)[0].id;
                                    console.log('Changing to '+$(this)[0].id);
                                    drawChart();
                                }
                            });
                        });

                        // canvas drawing context
                        var ctx;
                        var graphObject;

                        // place to store our raw datas
                        var chartJSON;

                        // cache all downloaded
                        var datasets = {};

                        var randomScalingFactor = function() {
                            return Math.round(Math.random() * 100)
                        };

                        // what are we showing now?
                        var currentChart = "demand";
                        var currentInterval = "lastHour";

                        // Obj to store our working data for the chart
                        var chartData = {
                            labels: ["Label1", "Label2", "Label3", "Label4", "Label5", "Label6"],
                            datasets: [
                                {
                                    label: "demand",
                                    fillColor: "rgba(220,220,220,0.2)",
                                    strokeColor: "rgba(220,220,220,1)",
                                    pointColor: "rgba(220,220,220,1)",
                                    pointStrokeColor: "#fff",
                                    pointHighlightFill: "#fff",
                                    pointHighlightStroke: "rgba(220,220,220,1)",
                                    data: [randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor()]
                                }
                            ]

                        };

                        // loading indicator
                        var opts = {
                          lines: 13, // The number of lines to draw
                          length: 4, // The length of each line
                          width: 10, // The line thickness
                          radius: 4, // The radius of the inner circle
                          corners: 1, // Corner roundness (0..1)
                          rotate: 0, // The rotation offset
                          direction: 1, // 1: clockwise, -1: counterclockwise
                          color: '#000', // #rgb or #rrggbb or array of colors
                          speed: 1, // Rounds per second
                          trail: 60, // Afterglow percentage
                          shadow: false, // Whether to render a shadow
                          hwaccel: false, // Whether to use hardware acceleration
                          className: 'spinner', // The CSS class to assign to the spinner
                          zIndex: 10000, // The z-index (defaults to 2000000000)
                          top: '50%', // Top position relative to parent
                          left: '50%' // Left position relative to parent
                        };    
                        var target = document.getElementById('graphContainer');
                        var spinner = new Spinner(opts).spin(target);

                        // disable controls if we're loading already
                        var isLoading = true;
                        

                        window.onload = initGraph;

                        function initGraph(){

                            

                            var jqxhr = $.getJSON( "http://cyberscot.co.uk/powerofknoydart/getReading.php?type=lastHour")
                              .done(function(d) {

                                spinner.stop();
                                isLoading = false;

                                chartJSON = d;

                                // cut down the json to every 10th second (most fine grained that we need)
                                var slimArray = new Array();
                                for (var i = 0; i < chartJSON.length; i++) {
                                    if (i % 10 == 0) {
                                        slimArray.push(chartJSON[i]);
                                    }
                                }

                                // discard all the excess json
                                chartJSON = slimArray;

                                // pull out a reasonable number of labels for the buttom (6)
                                var nthValue = Math.floor(chartJSON.length / 6);
 

                                datasets.lastHour = {};
                                datasets.lastDay = {};
                                datasets.lastWeek = {};
                                datasets.lastMonth = {}

                                datasets.lastHour.demand = new Array();
                                datasets.lastHour.rainfall = new Array();
                                datasets.lastHour.dam_lvl = new Array();
                                datasets.lastHour.production = new Array();

                                var chartDateLabels = new Array();

                                for (var i = 0; i < chartJSON.length; i++) {

                                    datasets.lastHour.demand.push(chartJSON[i].pow_act);
                                    datasets.lastHour.rainfall.push(chartJSON[i].rain);
                                    datasets.lastHour.dam_lvl.push(chartJSON[i].dam_lvl);
                                    datasets.lastHour.production.push(chartJSON[i].elster);

                                    if (i % nthValue == 0) {
                                        chartDateLabels.push(chartJSON[i].datetime);
                                    }
                                }
                                chartData.labels = chartDateLabels;
                                chartData.datasets[0].data = datasets.lastHour.power;

                                drawChart();
                                
                              })
                              .fail(function() {
                                console.log( "error" );
                                spinner.stop();
                                isLoading = false;
                              })
                              .always(function() {
                                // console.log( "complete" );
                              });

                            
                        }

                        function drawChart(){
                            resetCanvas();

                            if(currentChart === "demand"){
                                formatChartData(false);
                                graphObject = new Chart(ctx).Line(chartData, {
                                    responsive: true
                                });
                            }else if (currentChart === "rainfall") {
                                formatChartData(true);
                                graphObject = new Chart(ctx).LineBar(chartData, {
                                    responsive: true
                                });
                            }else if(currentChart === "production"){
                                formatChartData(false);
                                // console.log('Context before bar draw: ');
                                // console.log(ctx);
                                graphObject = new Chart(ctx).Bar(chartData, {
                                    responsive: true
                                });
                            }
                            console.log(chartData);
                        }

                        function formatChartData(isLineBar) {
                            
                            if(currentChart === "rainfall"){
                                chartData.datasets[0] = newBlankDataSet('bar');
                                chartData.datasets[0].data = datasets[currentInterval]['dam_lvl'];
                                chartData.datasets[1] = newBlankDataSet('line');
                                chartData.datasets[1].data = datasets[currentInterval][currentChart];
                            }else{
                                chartData.datasets[0] = newBlankDataSet('line');
                                chartData.datasets[0].data = datasets[currentInterval][currentChart];
                            }
                            
                        }

                        function resetCanvas(){
                          $('#graphCanvas').remove();
                          if(graphObject){
                            graphObject.destroy();
                            graphObject = {};
                          }

                          chartData.datasets = [];
                          
                          $('.graphContainer').append('<canvas id="graphCanvas"><canvas>');
                          ctx = document.getElementById("graphCanvas").getContext("2d");
                          // console.log('Context in resetCanvas: ');
                          // console.log(ctx);
                          ctx.canvas.clientHeight = $('.graphContainer')[0].clientHeight; // resize to parent width
                          ctx.canvas.clientWidth = $('.graphContainer')[0].clientWidth; // resize to parent width
                        }


                        function newBlankDataSet(t){
                            var obj = {
                                    label: 'placeholder',
                                    type: t,
                                    fillColor: "rgba(220,220,220,0.2)",
                                    strokeColor: "rgba(220,220,220,1)",
                                    pointColor: "rgba(220,220,220,1)",
                                    pointStrokeColor: "#fff",
                                    pointHighlightFill: "#fff",
                                    pointHighlightStroke: "rgba(220,220,220,1)",
                                    data: [randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor()]
                                };
                            return obj;
                        }

                        function downloadDataset(type){
                            spinner.spin(target);
                            isLoading = true;

                            var granularity = 3600;

                            if(type === "lastHour"){
                                granularity = 10;
                            }

                            var jqxhr = $.getJSON( "http://cyberscot.co.uk/powerofknoydart/getReading.php?type="+type)
                              .done(function(d) {

                                spinner.stop();
                                isLoading = false;

                                console.log(d);

                                // chartJSON = d;

                                // // cut down the json to every 10th second (most fine grained that we need)
                                // var slimArray = new Array();
                                // for (var i = 0; i < chartJSON.length; i++) {
                                //     if (i % granularity == 0) {
                                //         slimArray.push(chartJSON[i]);
                                //     }
                                // }

                                // // discard all the excess json
                                // chartJSON = slimArray;

                                // // pull out a reasonable number of labels for the buttom (6)
                                // var nthValue = Math.floor(chartJSON.length / 6);

                                // datasets[type].demand = new Array();
                                // datasets[type].rainfall = new Array();
                                // datasets[type].dam_lvl = new Array();
                                // datasets[type].production = new Array();

                                // var chartDateLabels = new Array();

                                // for (var i = 0; i < chartJSON.length; i++) {

                                //     datasets[type].demand.push(chartJSON[i].pow_act);
                                //     datasets[type].rainfall.push(chartJSON[i].rain);
                                //     datasets[type].dam_lvl.push(chartJSON[i].dam_lvl);
                                //     datasets[type].production.push(chartJSON[i].elster);

                                //     if (i % nthValue == 0) {
                                //         chartDateLabels.push(chartJSON[i].datetime);
                                //     }
                                // }
                                // chartData.labels = chartDateLabels;
                                // chartData.datasets[0].data = datasets[type].power;

                                // console.log(datasets[type]);
                                
                              })
                              .fail(function() {
                                console.log( "error" );
                                spinner.stop();
                                isLoading = false;
                              })
                              .always(function() {
                                // console.log( "complete" );
                              });
                        }




                    </script>

                    <section>
                        <a class="btn btn-large" href="#" style="text-align: center; color: #000;">
                            <i class="icon-time icon-2x pull-left" style="color: red;"></i> <br>Hour</a>
                        <a class="btn btn-large" href="#" style="text-align: center; color: #000;">
                            <i class="icon-sun icon-2x pull-left" style="color: red;"></i> <br>Day</a>
                        <a class="btn btn-large" href="#" style="text-align: center; color: #000;">
                            <i class="icon-time icon-2x pull-left" style="color: red;"></i> <br>Week</a>
                        <a class="btn btn-large" href="#" style="text-align: center; color: #000;">
                            <i class="icon-calendar icon-2x pull-left" style="color: red;"></i> <br>Month</a>
<!--                     <button>Hour</button>
                        <button>Day</button>
                        <button>Week</button>
                        <button>Month</button>-->
                    </section>
                </article>

                <aside>
                    <h3>Info</h3>
                    <p>This chart shows a live data feed of electricity use in Knoydart, Inverness-shire. The Knoydart peninsula is not connected to the UK’s mainland road network or electricity grid. The peninsula is served by an independent green electricity supplier, Knoydart Renewables, that operates a hydro-electric system fed by Loch Bhraomisaig on the slopes of Beinn Buidhe. To read more, visit Knoydart Renewables’ website. For alternative ways of seeing data on energy use in Knoydart click here.</p>
                </aside>

            </div> <!-- #main -->
        </div> <!-- #main-container -->

        <div class="footer-container">
            <footer class="wrapper">
                <a href=""><img src="img/knoydart_foundation.png"></a>
                <a href=""><img src="img/esrc.png"></a>
                <a href=""><img src="img/uni_ed.png"></a>
                <a href=""><img src="img/comedscot.png"></a>
                <a href=""><img src="img/lowenergyscot.png"></a>
                <p>Knoydart Hydro Data by Knoydart Foundation is licensed under a Creative Commons</p>
                <p>Attribution-NonCommercial-NoDerivatives 4.0 International License.</p>
                <p>Based on a work at http://knoydart.modulo.ee/</p>
            </footer>
        </div>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.1.min.js"><\/script>')</script>

        <script src="js/main.js"></script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
                        (function(b, o, i, l, e, r) {
                            b.GoogleAnalyticsObject = l;
                            b[l] || (b[l] =
                                    function() {
                                        (b[l].q = b[l].q || []).push(arguments)
                                    });
                            b[l].l = +new Date;
                            e = o.createElement(i);
                            r = o.getElementsByTagName(i)[0];
                            e.src = 'http://www.google-analytics.com/analytics.js';
                            r.parentNode.insertBefore(e, r)
                        }(window, document, 'script', 'ga'));
                        ga('create', 'UA-XXXXX-X');
                        ga('send', 'pageview');
        </script>
    </body>
</html>
